name: AV Capture Integration Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/modules/orchestrator/tools/av_capture.rs'
      - 'src/modules/orchestrator/tools/tests/**'
      - 'frontend/src/pages/MemoryTheater.tsx'
      - 'frontend/tests/av_capture_integration.test.tsx'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/modules/orchestrator/tools/av_capture.rs'
      - 'src/modules/orchestrator/tools/tests/**'
      - 'frontend/src/pages/MemoryTheater.tsx'
      - 'frontend/tests/av_capture_integration.test.tsx'
  workflow_dispatch:  # Allow manual triggering

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  NODE_VERSION: '20'

jobs:
  test-rust-windows:
    name: Test Rust AV Capture on Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
        
    - name: Install dependencies
      run: |
        # Install OpenCV
        choco install -y opencv
        
        # Install additional Windows-specific dependencies
        # These would be any Windows-specific dependencies needed for AV capture

    - name: Run tests
      run: |
        cargo test --package phoenix-orch --test av_capture_test -- --nocapture
        cargo test --package phoenix-orch --features "windows-tests" --test av_capture_test test_windows_specific_audio_capture -- --nocapture
        
    - name: Verify transcription accuracy
      run: |
        cargo test --package phoenix-orch --test av_capture_test transcription_accuracy_test -- --nocapture
        # In a real implementation, we would check the accuracy from the test output

    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: rust-test-results-windows
        path: |
          test-report.md
          test_results.log

  test-rust-macos:
    name: Test Rust AV Capture on macOS
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
        
    - name: Install dependencies
      run: |
        # Install OpenCV
        brew install opencv
        
        # Install additional macOS-specific dependencies
        # These would be any macOS-specific dependencies needed for AV capture

    - name: Run tests
      run: |
        cargo test --package phoenix-orch --test av_capture_test -- --nocapture
        cargo test --package phoenix-orch --features "macos-tests" --test av_capture_test test_macos_specific_audio_capture -- --nocapture
        
    - name: Verify transcription accuracy
      run: |
        cargo test --package phoenix-orch --test av_capture_test transcription_accuracy_test -- --nocapture
        # In a real implementation, we would check the accuracy from the test output

    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: rust-test-results-macos
        path: |
          test-report.md
          test_results.log

  test-rust-ubuntu:
    name: Test Rust AV Capture on Ubuntu
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
        
    - name: Install dependencies
      run: |
        # Install OpenCV and other dependencies
        sudo apt-get update
        sudo apt-get install -y libopencv-dev libasound2-dev libpulse-dev libpipewire-0.3-dev
        
        # Install additional Linux-specific dependencies
        # These would be any Linux-specific dependencies needed for AV capture

    - name: Run tests
      run: |
        cargo test --package phoenix-orch --test av_capture_test -- --nocapture
        cargo test --package phoenix-orch --features "linux-tests" --test av_capture_test test_linux_specific_audio_capture -- --nocapture
        
    - name: Verify transcription accuracy
      run: |
        cargo test --package phoenix-orch --test av_capture_test transcription_accuracy_test -- --nocapture
        # In a real implementation, we would check the accuracy from the test output

    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: rust-test-results-ubuntu
        path: |
          test-report.md
          test_results.log

  test-frontend:
    name: Test Frontend Integration
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
      
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run tests
      working-directory: ./frontend
      run: npm test tests/av_capture_integration.test.tsx
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: frontend-test-results
        path: frontend/test-results

  generate-report:
    name: Generate Cross-Platform Test Report
    needs: [test-rust-windows, test-rust-macos, test-rust-ubuntu, test-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all test results
      uses: actions/download-artifact@v3
      
    - name: Consolidate test results
      run: |
        mkdir -p combined-results
        cp -R rust-test-results-windows/* combined-results/ || true
        cp -R rust-test-results-macos/* combined-results/ || true
        cp -R rust-test-results-ubuntu/* combined-results/ || true
        cp -R frontend-test-results/* combined-results/ || true
        
    - name: Generate comprehensive report
      run: |
        cat > combined-results/cross-platform-report.md << EOL
        # Phoenix AV Capture Cross-Platform Test Report
        
        ## Summary
        
        - Date: $(date)
        - Commit: ${{ github.sha }}
        - Workflow: ${{ github.workflow }}
        
        ## Platform Results
        
        ### Windows
        $(cat combined-results/test-report.md 2>/dev/null || echo "No Windows results available")
        
        ### macOS
        $(cat combined-results/test-report.md 2>/dev/null || echo "No macOS results available")
        
        ### Ubuntu
        $(cat combined-results/test-report.md 2>/dev/null || echo "No Ubuntu results available")
        
        ## Frontend Integration
        $(cat combined-results/frontend-report.md 2>/dev/null || echo "No frontend results available")
        
        ## Cross-Platform Compatibility Assessment
        
        | Platform | Compatibility | Transcription Accuracy | Notes |
        |----------|---------------|------------------------|-------|
        | Windows 11 | $(grep -q "PASS" combined-results/windows.log 2>/dev/null && echo "✅" || echo "❌") | $(grep "accuracy:" combined-results/windows.log 2>/dev/null || echo "N/A") | |
        | macOS | $(grep -q "PASS" combined-results/macos.log 2>/dev/null && echo "✅" || echo "❌") | $(grep "accuracy:" combined-results/macos.log 2>/dev/null || echo "N/A") | |
        | Ubuntu | $(grep -q "PASS" combined-results/ubuntu.log 2>/dev/null && echo "✅" || echo "❌") | $(grep "accuracy:" combined-results/ubuntu.log 2>/dev/null || echo "N/A") | |
        
        ## Conclusion
        
        Overall assessment: $(grep -q "FAIL" combined-results/*.log 2>/dev/null && echo "❌ Some tests failed" || echo "✅ All tests passed")
        
        EOL
        
    - name: Upload combined report
      uses: actions/upload-artifact@v3
      with:
        name: cross-platform-test-report
        path: combined-results/cross-platform-report.md

    - name: Check transcription accuracy
      run: |
        WINDOWS_ACCURACY=$(grep "Transcription accuracy:" combined-results/windows.log 2>/dev/null | awk '{print $3}' | sed 's/%//g' || echo "0")
        MACOS_ACCURACY=$(grep "Transcription accuracy:" combined-results/macos.log 2>/dev/null | awk '{print $3}' | sed 's/%//g' || echo "0")
        UBUNTU_ACCURACY=$(grep "Transcription accuracy:" combined-results/ubuntu.log 2>/dev/null | awk '{print $3}' | sed 's/%//g' || echo "0")
        
        # Check if all platforms meet the 98% accuracy threshold
        if (( $(echo "$WINDOWS_ACCURACY < 98.0" | bc -l) )) || \
           (( $(echo "$MACOS_ACCURACY < 98.0" | bc -l) )) || \
           (( $(echo "$UBUNTU_ACCURACY < 98.0" | bc -l) )); then
          echo "❌ Transcription accuracy below 98% threshold on at least one platform"
          exit 1
        else
          echo "✅ Transcription accuracy meets or exceeds 98% threshold on all platforms"
        fi