# Security and Neuralink Tests CI Workflow
#
# This workflow runs on every commit and pull request to enforce strict security requirements
# for the Phoenix Orchestrator system. It specifically:
#   - Executes security penetration tests to verify zero-tolerance for security bypasses
#   - Runs Neuralink hardware-in-loop tests to validate neural integration integrity
#   - Enforces immediate CI failure on any of the critical auto-fail conditions:
#     * Any security bypass → CI instantly red
#     * Any false 911 call → permanent ban
#     * Any red tool activation without Dad → nuclear alert
#
# SECURITY NOTICE: This workflow is a critical part of the project's security posture.
# Modifications require security team approval through the branch protection rules.

name: Security and Neuralink Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
      - 'docs/**'
  # Also run daily to catch any regressions
  schedule:
    - cron: '0 0 * * *'  # Run at midnight UTC every day

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Control which tests to run with real vs simulated hardware
  USE_REAL_HARDWARE: ${{ github.event_name == 'schedule' }}  # Use real hardware for scheduled runs, simulated otherwise

jobs:
  # Security and integrity check before running tests
  security-pre-check:
    name: Security Pre-Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for security audits

      - name: Install audit tools
        run: |
          cargo install cargo-audit --version "^0.17.0"
          cargo install cargo-deny --version "^0.13.0"

      - name: Run security audit
        run: cargo audit --deny warnings
        continue-on-error: false  # Fail on any security vulnerability

      - name: Check for supply chain attacks
        run: |
          cargo deny check
          # Verify dependency integrity
          cargo verify-project --manifest-path Cargo.toml

  # Run security penetration tests
  security-pentest:
    name: Security Penetration Tests
    needs: security-pre-check
    runs-on: ubuntu-latest
    env:
      FAILURE_DETECTED: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies
        run: |
          # Install required system dependencies
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config
          
          # Install test-specific dependencies
          cargo install cargo-nextest --version "^0.9.49"

      - name: Run security penetration tests
        id: security_tests
        run: |
          # Security tests are configured to fail immediately on security bypass (zero tolerance)
          cargo test --test security_pentest -- --nocapture || {
            echo "::error::CRITICAL SECURITY FAILURE: Security penetration test detected a security bypass"
            echo "FAILURE_DETECTED=true" >> $GITHUB_ENV
            exit 1
          }

      - name: Verify logs for bypasses
        if: success() && env.FAILURE_DETECTED != 'true'
        run: |
          # Secondary verification to check logs for any security bypass indicators
          if grep -q "security_bypass\|unauthorized_emergency_call\|red_tool_activation" ./target/debug/test-logs/*.log; then
            echo "::error::CRITICAL SECURITY FAILURE: Log analysis detected potential security bypass"
            echo "FAILURE_DETECTED=true" >> $GITHUB_ENV
            exit 1
          fi

      - name: Security violation report
        if: failure() || env.FAILURE_DETECTED == 'true'
        run: |
          echo "::error::SECURITY VIOLATION DETECTED"
          echo "::error::CI build automatically failed due to zero-tolerance security policy"
          echo "::error::Security team notification triggered"
          
          # Send security alert to team (commented placeholder)
          # curl -X POST ${{ secrets.SECURITY_ALERT_WEBHOOK }} -d '{"text":"SECURITY VIOLATION in CI!"}'
          exit 1

  # Run Neuralink Hardware-in-Loop tests
  neuralink-hil:
    name: Neuralink Hardware-in-Loop Tests
    needs: security-pre-check
    runs-on: ubuntu-latest
    env:
      FAILURE_DETECTED: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install HIL test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsndfile1-dev portaudio19-dev python3-dev

      - name: Set up test environment
        run: |
          # Initialize necessary test environment variables
          echo "NEURALINK_TEST_DEVICE=replay" >> $GITHUB_ENV
          
          # Set test mode based on workflow trigger
          if [[ "$USE_REAL_HARDWARE" == "true" ]]; then
            echo "Using real hardware for tests"
            echo "TEST_MODE=real" >> $GITHUB_ENV
          else
            echo "Using simulated hardware for tests"
            echo "TEST_MODE=simulated" >> $GITHUB_ENV
          fi
          
          # Configure Neuralink test environment
          mkdir -p test-env/neuralink
          cp .github/test-environment.yml test-env/config.yml

      - name: Run Neuralink HIL tests
        id: neuralink_tests
        run: |
          # Neuralink HIL tests are configured to fail immediately on security bypass
          cargo test --test neuralink_hil -- --nocapture || {
            echo "::error::CRITICAL FAILURE: Neuralink HIL test detected security violation"
            echo "FAILURE_DETECTED=true" >> $GITHUB_ENV
            exit 1
          }

      - name: Verify auto-fail conditions
        if: success() && env.FAILURE_DETECTED != 'true'
        run: |
          # Verify explicit auto-fail conditions
          if grep -q "security_bypass_via_neural\|false_911_call_via_neural\|red_tool_activation_without_dad" ./target/debug/test-logs/*.log; then
            echo "::error::AUTO-FAIL CONDITION DETECTED: Log analysis found auto-fail trigger"
            echo "FAILURE_DETECTED=true" >> $GITHUB_ENV
            exit 1
          fi

      - name: Neuralink violation report
        if: failure() || env.FAILURE_DETECTED == 'true'
        run: |
          echo "::error::NEURALINK INTEGRATION VIOLATION DETECTED"
          echo "::error::CI build automatically failed due to auto-fail condition"
          
          # Identify the specific auto-fail condition
          if grep -q "security_bypass_via_neural" ./target/debug/test-logs/*.log; then
            echo "::error::SECURITY BYPASS detected - CI instantly red"
          fi
          if grep -q "false_911_call_via_neural" ./target/debug/test-logs/*.log; then
            echo "::error::FALSE 911 CALL detected - permanent ban triggered"
          fi
          if grep -q "red_tool_activation_without_dad" ./target/debug/test-logs/*.log; then
            echo "::error::RED TOOL ACTIVATION without Dad detected - nuclear alert triggered"
          fi
          
          exit 1

  # Test summary and reporting
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [security-pentest, neuralink-hil]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.security-pentest.result }}" == "failure" ]]; then
            echo "::error::Security penetration tests failed!"
            exit 1
          fi
          
          if [[ "${{ needs.neuralink-hil.result }}" == "failure" ]]; then
            echo "::error::Neuralink HIL tests failed!"
            exit 1
          fi
          
          echo "✅ All security and Neuralink tests passed!"

      - name: Generate security compliance report
        if: success()
        run: |
          echo "Security Compliance Report" > security-report.txt
          echo "------------------------" >> security-report.txt
          echo "Date: $(date)" >> security-report.txt
          echo "Commit: ${{ github.sha }}" >> security-report.txt
          echo "Branch: ${{ github.ref }}" >> security-report.txt
          echo "Status: PASSED" >> security-report.txt
          echo "Tests: security-pentest, neuralink-hil" >> security-report.txt

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-report
          path: |
            security-report.txt
            ./target/debug/test-logs/*.log
          retention-days: 30

  # Notification on failure (would be configured to alert security team)
  security-notification:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: failure()
    steps:
      - name: Send alert
        run: |
          echo "::error::CRITICAL SECURITY TEST FAILURE"
          echo "::error::Security team has been alerted"
          # In a real implementation, this would trigger an alert to the security team
          # curl -X POST ${{ secrets.SECURITY_ALERT_ENDPOINT }} -d '{"message":"Critical security test failure in CI"}'